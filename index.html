<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Lavender Music Card ¬∑ YT Music (Large Cover)</title>
<style>
:root{ --purple:#6c38f8; --purple2:#5a2de6; --bg:#f5f4ff; --ink:#fff; --ink2:#e8deff; --shadow:0 16px 32px rgba(73,43,170,.25) }
*{box-sizing:border-box} body{margin:0;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Pretendard,system-ui,sans-serif}
.wrap{max-width:860px;margin:22px auto;padding:0 14px}

/* Ìó§Îçî + ÎìúÎ°≠Îã§Ïö¥ */
.header{display:flex;justify-content:space-between;align-items:center;gap:10px}
h2{margin:0;color:#4d2ee6;font-weight:900;font-size:18px}
.dropdown{width:100%;margin:10px 0 6px}
summary{list-style:none;cursor:pointer;padding:8px 12px;border:2px solid #d9d3ff;border-radius:12px;background:#fff;color:#4d2ee6;font-weight:700;display:flex;align-items:center;gap:8px}
summary::-webkit-details-marker{display:none}
summary .chev{transition:transform .2s}
details[open] summary .chev{transform:rotate(90deg)}
.panel{padding:12px;border:2px solid #e7e2ff;border-top:0;border-radius:0 0 12px 12px;background:#fbfaff}
.ctrl{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.ctrl label{font-size:12px;color:#7a6fb8}
.ctrl input[type="text"]{height:34px;border-radius:10px;border:2px solid #d9d3ff;padding:0 10px;background:#fff;min-width:180px}
.ctrl input[type="file"]{height:34px}
.smallbtn{height:30px;border:0;border-radius:8px;padding:0 10px;background:#e9e0ff;color:#4d2ee6;font-size:12px}
.lock{padding:2px 6px;border-radius:6px;background:#e9e0ff;color:#4d2ee6;font-size:11px;margin-left:6px}

/* Í≤ÄÏÉâ/Í≤∞Í≥º */
.search{display:flex;gap:8px;margin:8px 0 14px}
.search input{flex:1;height:42px;border-radius:12px;border:2px solid #d9d3ff;padding:0 12px;font-size:15px;background:#fff}
.results{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:8px;margin-bottom:16px}
.item{display:flex;gap:10px;align-items:center;padding:8px;border-radius:12px;border:1px solid #eee;background:#fff;cursor:pointer}
.item img{width:56px;height:56px;border-radius:10px;object-fit:cover}
.item .t{font-weight:700;font-size:13px}
.item .s{font-size:12px;color:#666}

/* Ïπ¥Îìú */
.card{display:flex;gap:16px;align-items:center;padding:18px;border-radius:22px;color:var(--ink);
  background:linear-gradient(90deg,var(--purple),var(--purple2));box-shadow:var(--shadow);max-width:780px;margin:0 auto}
.cover{width:160px;height:160px;border-radius:18px;overflow:hidden;flex:0 0 160px;box-shadow:0 10px 20px rgba(0,0,0,.2)}
.cover img{width:100%;height:100%;object-fit:cover}
.meta{flex:1;min-width:220px}
.title{font-size:22px;font-weight:800;letter-spacing:.2px}
.artist{margin-top:6px;font-size:12px;color:var(--ink2)}
.controls{display:flex;gap:8px;align-items:center;margin:10px 0}
.btn{width:38px;height:38px;border-radius:50%;border:0;background:#1b1a1f;color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer}
.play{width:46px;height:46px;border-radius:50%;background:#fff;color:#1b1a1f;font-weight:800}
.btn[disabled]{opacity:.5;cursor:not-allowed}
.wave{display:flex;align-items:flex-end;gap:4px;height:70px;opacity:.95}
.bar{width:6px;background:rgba(255,255,255,.75);border-radius:6px;animation:up 1.2s ease-in-out infinite;transform-origin:bottom}
.bar:nth-child(odd){animation-duration:1s}.bar:nth-child(3n){animation-duration:1.4s}
@keyframes up{0%,100%{height:20%}50%{height:85%}}
#player{width:0;height:0;overflow:hidden}
.badge{font-size:11px;color:#f1e6ff;opacity:.9;margin-right:6px}

/* Î∞òÏùëÌòï */
@media (max-width:640px){
  .cover{width:120px;height:120px;flex:0 0 120px}
  .title{font-size:20px}
  .wave{height:64px}
}
</style>
</head>
<body>
<div class="wrap">
  <div class="header"><h2>Lavender Music Card</h2></div>

  <!-- ÎìúÎ°≠Îã§Ïö¥ ÏÑ§Ï†ï -->
  <details class="dropdown" id="opt">
    <summary><span class="chev">‚ñ∂</span> ÏÑ§Ï†ï Ïó¥Í∏∞/Îã´Í∏∞</summary>
    <div class="panel">
      <div class="ctrl">
        <label>ÌëúÏãú Ï±ÑÎÑêÎ™Ö</label>
        <input id="channelInput" type="text" placeholder="Ïòà: ÏûÑÌïòÎ∞ç">
        <label>Ïª§Î≤Ñ URL</label>
        <input id="coverUrl" type="text" placeholder="https://...jpg (ÏóîÌÑ∞)">
        <label>Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú</label>
        <input id="coverFile" type="file" accept="image/*">
        <button id="coverReset" class="smallbtn">ÏõêÎûò Ïç∏ÎÑ§Ïùº</button>
        <span id="coverLock" class="lock" style="display:none">Ïª§Î≤Ñ Í≥†Ï†ï</span>
      </div>
    </div>
  </details>

  <div class="search">
    <input id="q" type="search" placeholder="ÎÖ∏Îûò/ÏïÑÌã∞Ïä§Ìä∏ Í≤ÄÏÉâ (Ïòà: ÏïÑÏù¥Ïú† ÎäêÎ¶¨Í≤å ÌïòÎäî Ïùº)">
  </div>

  <div id="results" class="results"></div>

  <!-- Player Card -->
  <div id="card" class="card" style="display:none">
    <div class="cover"><img id="art" alt="cover"></div>
    <div class="meta">
      <div class="title" id="title">Ï†úÎ™©</div>
      <div class="artist"><span class="badge">SING üé§</span><span id="artistTag">Ï±ÑÎÑê</span></div>
      <div class="controls">
        <button id="prevBtn" class="btn" title="Prev">&#9664;&#9664;</button>
        <button id="playBtn" class="btn play" title="Play/Pause">‚ñ∂</button>
        <button id="nextBtn" class="btn" title="Next">&#9654;&#9654;</button>
      </div>
      <div class="wave" id="wave"></div>
    </div>
  </div>

  <div id="player"></div>
</div>

<script>
/* ===== API Key (ÌïÑÏàò: ÎèÑÎ©îÏù∏ Ï†úÌïú ÏÑ§Ï†ï Í∂åÏû•) ===== */
const YOUTUBE_API_KEY = 'AIzaSyBpGXON0rj8kUagY32Gl6vUWiUDlpcsTD4';

/* ===== State ===== */
let currentList = [];
let currentIndex = -1;
let player, isPlaying = false;
let defaultThumb = '';
let customCover = null;     // URL/dataURL
let customCoverLocked = false;
const params = new URLSearchParams(location.search);
const REGION = (params.get('region') || 'KR').toUpperCase();

/* ===== Utils ===== */
function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
function $(s){ return document.querySelector(s); }
function createBars(n=48){ const w=$('#wave'); w.innerHTML=''; for(let i=0;i<n;i++){const b=document.createElement('div'); b.className='bar'; b.style.height=(20+Math.random()*60)+'%'; w.appendChild(b);} }

/* Ï†úÎ™© Ï†ïÎ¶¨ */
function cleanBrackets(s){
  s = s.replace(/\[[^\]]*\]/g,'');                                  // [ ... ]
  s = s.replace(/[\(\{\<„Äà„ÄäÔºà][^()\{}\<>„Äà„Äâ„Ää„ÄãÔºàÔºâ]*[\)\}\>„Äâ„ÄãÔºâ]/g,''); // (..), {..}, <..>, „Äà..„Äâ, „Ää..„Äã, Ôºà..Ôºâ
  s = s.replace(/\s*\/\s*(official.*|lyrics?.*|audio.*|mv.*|music\s*video.*|live.*)$/ig,'');
  s = s.replace(/\s*\|\s*.*$/,'');
  s = s.replace(/\s{2,}/g,' ').trim();
  return s;
}
function prettify(raw){
  if(!raw) return {title:'',artist:''};
  let s = cleanBrackets(raw);
  const m = s.match(/^(.*?)[\-\‚Äì]\s*(.+)$/);          // artist - title
  if(m){ return { title: cleanBrackets(m[2].trim()), artist: m[1].trim() }; }
  return { title:s, artist:'' };
}

/* ===== YouTube API ===== */
async function yt(endpoint, params){
  const url = new URL('https://www.googleapis.com/youtube/v3/'+endpoint);
  params.key = YOUTUBE_API_KEY;
  Object.entries(params).forEach(([k,v])=>url.searchParams.set(k,v));
  const r = await fetch(url);
  if(!r.ok) throw new Error('YouTube API '+r.status);
  return r.json();
}

/* Ïû¨ÏÉù Í∞ÄÎä• Ïó¨Î∂Ä ÌïÑÌÑ∞ */
function isPlayable(v){
  if(!v) return false;
  if(v.status?.privacyStatus !== 'public') return false;
  if(!v.status?.embeddable) return false;
  if(v.contentDetails?.contentRating?.ytRating === 'ytAgeRestricted') return false;
  const rr = v.contentDetails?.regionRestriction;
  if(rr?.blocked && rr.blocked.includes(REGION)) return false;
  if(rr?.allowed && !rr.allowed.includes(REGION)) return false;
  return true;
}

/* Í≤ÄÏÉâ */
const doSearch = debounce(async ()=>{
  const q = $('#q').value.trim(); $('#results').innerHTML='';
  if(!q) return;

  const data = await yt('search',{
    part:'snippet', type:'video', maxResults:18, q,
    videoEmbeddable:'true', videoSyndicated:'true'
  });

  const ids = data.items.map(i=>i.id.videoId).join(',');
  if(!ids){ currentList=[]; return; }

  // ‚òÖ contentRatingÏùÄ contentDetails ÏïàÏóê ÏûàÏùå ‚Üí partÏóêÏÑú Ï†úÏô∏
  const vinfo = await yt('videos',{ part:'snippet,contentDetails,status', id:ids });
  const byId = Object.fromEntries(vinfo.items.map(v=>[v.id,v]));

  const playable = data.items.filter(it => isPlayable(byId[it.id.videoId]));

  const music=[], others=[];
  for(const it of playable){
    const v = byId[it.id.videoId];
    const row = {
      id: it.id.videoId,
      title: it.snippet.title,
      artist: it.snippet.channelTitle,
      thumb: (it.snippet.thumbnails.high||it.snippet.thumbnails.medium||it.snippet.thumbnails.default).url
    };
    (v?.snippet?.categoryId==='10' ? music : others).push(row);
  }
  currentList = music.length ? music : others;
  currentIndex = -1;

  const box=$('#results'); box.innerHTML='';
  currentList.forEach((t,idx)=>{
    const pp = prettify(t.title);
    const line = pp.artist ? `${pp.title} - ${pp.artist}` : pp.title;
    const div=document.createElement('div'); div.className='item';
    div.innerHTML = `<img src="${t.thumb}"><div><div class="t">${line}</div><div class="s">${t.artist}</div></div>`;
    div.addEventListener('click', ()=>selectTrack(idx));
    box.appendChild(div);
  });
},300);
$('#q').addEventListener('input', doSearch);

/* YT Iframe Player */
function onYouTubeIframeAPIReady(){
  player = new YT.Player('player',{
    height:'0', width:'0', videoId:'',
    playerVars:{playsinline:1,rel:0,modestbranding:1},
    events:{
      onStateChange(e){
        if(e.data===YT.PlayerState.PLAYING){ isPlaying=true; $('#playBtn').textContent='‚è∏'; }
        else if(e.data===YT.PlayerState.PAUSED || e.data===YT.PlayerState.ENDED){ isPlaying=false; $('#playBtn').textContent='‚ñ∂'; }
      },
      onError(){ if(currentIndex < currentList.length-1) selectTrack(currentIndex+1); }
    }
  });
}
window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;
const s=document.createElement('script'); s.src='https://www.youtube.com/iframe_api'; document.body.appendChild(s);

/* Ïπ¥Îìú Î†åÎçîÎßÅ */
function applyCover(){
  $('#coverLock').style.display = customCoverLocked ? 'inline-block' : 'none';
  $('#art').src = (customCoverLocked && customCover) ? customCover : defaultThumb;
}
function selectTrack(idx){
  const t=currentList[idx]; if(!t) return; currentIndex=idx;
  $('#card').style.display='flex';
  defaultThumb = t.thumb;
  const pp = prettify(t.title);
  $('#title').textContent = pp.artist ? `${pp.title} - ${pp.artist}` : pp.title;
  const manual = ($('#channelInput').value||'').trim();
  $('#artistTag').textContent = manual || t.artist;
  createBars(48);
  if(player?.loadVideoById){ player.loadVideoById(t.id); }
  applyCover();
}

/* Ïª®Ìä∏Î°§ */
$('#playBtn').addEventListener('click',()=>{ if(!player) return; if(isPlaying) player.pauseVideo(); else player.playVideo(); });
$('#prevBtn').addEventListener('click',()=>{ if(currentIndex>0) selectTrack(currentIndex-1); });
$('#nextBtn').addEventListener('click',()=>{ if(currentIndex<currentList.length-1) selectTrack(currentIndex+1); });

/* Ï±ÑÎÑêÎ™Ö Ï†ÄÏû•/Î≥µÏõê */
const channelInput = $('#channelInput');
const savedCh = localStorage.getItem('yt_card_channel'); if(savedCh) channelInput.value=savedCh;
channelInput.addEventListener('input', ()=>{ localStorage.setItem('yt_card_channel', channelInput.value||''); if($('#card').style.display!=='none') $('#artistTag').textContent = channelInput.value || $('#artistTag').textContent; });

/* Ïª§Î≤Ñ ÍµêÏ≤¥ (URL/ÌååÏùº/ÏõêÎ≥µ) */
$('#coverUrl').addEventListener('keydown', e=>{
  if(e.key==='Enter'){
    const url = e.target.value.trim();
    if(url){ customCover=url; customCoverLocked=true; localStorage.setItem('yt_card_custom_cover',url); localStorage.setItem('yt_card_cover_locked','1'); applyCover(); }
  }
});
$('#coverFile').addEventListener('change', e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const reader=new FileReader();
  reader.onload = ev => { customCover=ev.target.result; customCoverLocked=true; localStorage.setItem('yt_card_custom_cover',customCover); localStorage.setItem('yt_card_cover_locked','1'); applyCover(); };
  reader.readAsDataURL(f);
});
$('#coverReset').addEventListener('click', ()=>{ customCover=null; customCoverLocked=false; localStorage.removeItem('yt_card_custom_cover'); localStorage.removeItem('yt_card_cover_locked'); applyCover(); });

/* Í≥µÏú†Ïö© URL ÌååÎùºÎØ∏ÌÑ∞ (?channel=Ïù¥Î¶Ñ&cover=https://...&region=KR) */
(function fromQuery(){
  const ch = params.get('channel'); const cv = params.get('cover');
  if(ch){ channelInput.value=ch; localStorage.setItem('yt_card_channel',ch); }
  if(cv){ customCover=cv; customCoverLocked=true; localStorage.setItem('yt_card_custom_cover',cv); localStorage.setItem('yt_card_cover_locked','1'); }
})();

/* ÏÉàÎ°úÍ≥†Ïπ® Î≥µÏõê */
(function restore(){
  const c = localStorage.getItem('yt_card_custom_cover');
  const locked = localStorage.getItem('yt_card_cover_locked')==='1';
  if(c){ customCover=c; customCoverLocked=locked; }
})();
</script>
</body>
</html>
