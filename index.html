<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Lavender Music Card Â· YT Music</title>
<style>
:root{ --purple:#6c38f8; --purple2:#5a2de6; --bg:#f5f4ff; --ink:#fff; --ink2:#e8deff; }
*{box-sizing:border-box}
body{margin:0;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Pretendard,sans-serif}
.wrap{max-width:860px;margin:22px auto;padding:0 14px}

/* í—¤ë” + ë“œë¡­ë‹¤ìš´ */
.header{display:flex;justify-content:space-between;align-items:center;gap:10px}
h2{margin:0;color:#4d2ee6;font-weight:900;font-size:18px}
.dropdown{width:100%;margin:10px 0 6px}
summary{list-style:none;cursor:pointer;padding:8px 12px;border:2px solid #d9d3ff;border-radius:12px;background:#fff;color:#4d2ee6;font-weight:700;display:flex;align-items:center;gap:8px}
summary::-webkit-details-marker{display:none}
summary .chev{transition:transform .2s}
details[open] summary .chev{transform:rotate(90deg)}
.panel{padding:12px;border:2px solid #e7e2ff;border-top:0;border-radius:0 0 12px 12px;background:#fbfaff}
.ctrl{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.ctrl label{font-size:12px;color:#7a6fb8}
.ctrl input[type="text"]{height:34px;border-radius:10px;border:2px solid #d9d3ff;padding:0 10px;background:#fff;min-width:180px}
.ctrl input[type="file"]{height:34px}
.smallbtn{height:30px;border:0;border-radius:8px;padding:0 10px;background:#e9e0ff;color:#4d2ee6;font-size:12px}
.lock{padding:2px 6px;border-radius:6px;background:#e9e0ff;color:#4d2ee6;font-size:11px;margin-left:6px}

/* ê²€ìƒ‰/ê²°ê³¼ */
.search{display:flex;gap:8px;margin:8px 0 14px}
.search input{flex:1;height:42px;border-radius:12px;border:2px solid #d9d3ff;padding:0 12px;font-size:15px;background:#fff}
.results{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:8px;margin-bottom:120px}
.item{display:flex;gap:10px;align-items:center;padding:8px;border-radius:12px;border:1px solid #eee;background:#fff;cursor:pointer}
.item img{width:56px;height:56px;border-radius:10px;object-fit:cover}
.item .t{font-weight:700;font-size:13px}
.item .s{font-size:12px;color:#666}

/* í”Œë ˆì´ì–´ ì¹´ë“œ (í•˜ë‹¨ ê³ ì •) */
.card{position:fixed;bottom:0;left:0;right:0;z-index:9999;
  display:flex;gap:16px;align-items:center;padding:16px 20px;
  border-radius:20px 20px 0 0;color:var(--ink);
  background:linear-gradient(90deg,var(--purple),var(--purple2));
  box-shadow:0 -4px 14px rgba(0,0,0,.25);max-width:860px;margin:0 auto}
.cover{width:90px;height:90px;border-radius:14px;overflow:hidden;flex:0 0 90px;box-shadow:0 5px 12px rgba(0,0,0,.25)}
.cover img{width:100%;height:100%;object-fit:cover}
.meta{flex:1;min-width:160px}
.title{font-size:18px;font-weight:800;letter-spacing:.2px}
.artist{margin-top:6px;font-size:12px;color:var(--ink2)}
.controls{display:flex;gap:8px;align-items:center;margin:8px 0}
.btn{width:34px;height:34px;border-radius:50%;border:0;background:#1b1a1f;color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:14px}
.play{width:42px;height:42px;border-radius:50%;background:#fff;color:#1b1a1f;font-weight:800;font-size:16px}
.wave{display:flex;align-items:flex-end;gap:3px;height:50px;opacity:.95}
.bar{width:4px;background:rgba(255,255,255,.75);border-radius:6px;animation:up 1.2s ease-in-out infinite;transform-origin:bottom}
.bar:nth-child(odd){animation-duration:1s}.bar:nth-child(3n){animation-duration:1.4s}
@keyframes up{0%,100%{height:20%}50%{height:85%}}
#player{width:0;height:0;overflow:hidden}
.badge{font-size:11px;color:#f1e6ff;opacity:.9;margin-right:6px}

/* ë³¼ë¥¨ ìŠ¬ë¼ì´ë” */
.volbox{width:40px;height:90px;display:flex;align-items:center;justify-content:center;margin-left:8px}
#vol{-webkit-appearance:slider-vertical;writing-mode:bt-lr;width:20px;height:80px;background:transparent}
#vol::-webkit-slider-runnable-track{background:rgba(255,255,255,.35);border-radius:8px;width:6px;border:none}
#vol::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:8px;border-radius:8px;background:#fff;margin-top:-2px;box-shadow:0 1px 3px rgba(0,0,0,.25)}
#vol::-moz-range-track{background:rgba(255,255,255,.35);border-radius:8px}
#vol::-moz-range-thumb{width:18px;height:8px;border-radius:8px;border:none;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,.25)}
</style>
</head>
<body>
<div class="wrap">
  <div class="header"><h2>Lavender Music Card</h2></div>

  <!-- ë“œë¡­ë‹¤ìš´ ì„¤ì • -->
  <details class="dropdown" id="opt">
    <summary><span class="chev">â–¶</span> ì„¤ì • ì—´ê¸°/ë‹«ê¸°</summary>
    <div class="panel">
      <div class="ctrl">
        <label>í‘œì‹œ ì±„ë„ëª…</label>
        <input id="channelInput" type="text" placeholder="ì˜ˆ: ì„í•˜ë°">
        <label>ì»¤ë²„ URL</label>
        <input id="coverUrl" type="text" placeholder="https://...jpg (ì—”í„°)">
        <label>ì´ë¯¸ì§€ ì—…ë¡œë“œ</label>
        <input id="coverFile" type="file" accept="image/*">
        <button id="coverApply" class="smallbtn">ì»¤ë²„ ì ìš©</button>
        <button id="coverReset" class="smallbtn">ì›ë˜ ì¸ë„¤ì¼</button>
        <span id="coverLock" class="lock" style="display:none">ì»¤ë²„ ê³ ì •</span>
      </div>
    </div>
  </details>

  <div class="search"><input id="q" type="search" placeholder="ë…¸ë˜/ì•„í‹°ìŠ¤íŠ¸ ê²€ìƒ‰"></div>
  <div id="results" class="results"></div>
</div>

<!-- ê³ ì • í”Œë ˆì´ì–´ -->
<div id="card" class="card" style="display:none">
  <div class="cover"><img id="art" alt="cover"></div>
  <div class="meta">
    <div class="title" id="title">ì œëª©</div>
    <div class="artist"><span class="badge">SING ğŸ¤</span><span id="artistTag">ì±„ë„</span></div>
    <div class="controls">
      <button id="prevBtn" class="btn" title="Prev">&#9664;&#9664;</button>
      <button id="playBtn" class="btn play" title="Play/Pause">â–¶</button>
      <button id="nextBtn" class="btn" title="Next">&#9654;&#9654;</button>
      <button id="muteBtn" class="btn" title="Mute">ğŸ”Š</button>
    </div>
    <div class="wave" id="wave"></div>
  </div>
  <div class="volbox"><input id="vol" type="range" min="0" max="100" step="1" value="40" orient="vertical"></div>
</div>

<div id="player"></div>

<script>
/* â–¼â–¼ í•„ìˆ˜: ë³¸ì¸ í‚¤ë¡œ êµì²´ (ê³µê°œ ë°°í¬ëŠ” í”„ë¡ì‹œ ê¶Œì¥) â–¼â–¼ */
const YOUTUBE_API_KEY = 'AIzaSyBpGXON0rj8kUagY32Gl6vUWiUDlpcsTD4';
/* â–²â–² */

let currentList=[], currentIndex=-1, player,isPlaying=false;
let defaultThumb='',customCover=null,customCoverLocked=false;
const params=new URLSearchParams(location.search);
const REGION=(params.get('region')||'KR').toUpperCase();
const DEFAULT_VOLUME = Number(localStorage.getItem('yt_card_vol')||40);

/* ìœ í‹¸ */
function $(s){return document.querySelector(s);}
function createBars(n=40){const w=$('#wave');w.innerHTML='';for(let i=0;i<n;i++){const b=document.createElement('div');b.className='bar';b.style.height=(20+Math.random()*60)+'%';w.appendChild(b);}}
function toast(msg, ms=2000){
  let t=document.getElementById('toast');
  if(!t){ t=document.createElement('div'); t.id='toast';
    Object.assign(t.style,{position:'fixed',bottom:'110px',left:'50%',transform:'translateX(-50%)',
      background:'rgba(0,0,0,.75)',color:'#fff',padding:'8px 12px',borderRadius:'10px',
      fontSize:'12px',zIndex:99999,transition:'opacity .2s'}); document.body.appendChild(t);}
  t.textContent=msg; t.style.opacity='1'; clearTimeout(toast._tm); toast._tm=setTimeout(()=>t.style.opacity='0',ms);
}

/* ì œëª© ì •ë¦¬ */
function cleanBrackets(s){
  s=s.replace(/\[[^\]]*\]/g,'');
  s=s.replace(/[\(\{\<ã€ˆã€Šï¼ˆ][^()\{}\<>ã€ˆã€‰ã€Šã€‹ï¼ˆï¼‰]*[\)\}\>ã€‰ã€‹ï¼‰]/g,'');
  s=s.replace(/\s*\/\s*(official.*|lyrics?.*|audio.*|mv.*|music\s*video.*|live.*)$/ig,'');
  s=s.replace(/\s*\|\s*.*$/,'');
  s=s.replace(/\s{2,}/g,' ').trim();
  return s;
}
function prettify(raw){
  if(!raw) return {title:'',artist:''};
  let s=cleanBrackets(raw);
  const m=s.match(/^(.*?)[\-\â€“]\s*(.+)$/);
  if(m){ return { title: cleanBrackets(m[2].trim()), artist: m[1].trim() }; }
  return { title:s, artist:'' };
}

/* ìš”ì²­ ì·¨ì†Œ/ìµœì‹ ì‘ë‹µ í† í° */
let activeControllers=[]; let searchSeq=0;
function cancelActive(){ activeControllers.forEach(c=>{try{c.abort()}catch(_){}}); activeControllers=[]; }

/* YouTube API (ì§ì ‘ í˜¸ì¶œ ë²„ì „ â€” í”„ë¡ì‹œ ì“°ë©´ ì—¬ê¸°ë§Œ ë°”ê¾¸ì„¸ìš”) */
async function yt(endpoint, params){
  const url=new URL('https://www.googleapis.com/youtube/v3/'+endpoint);
  params.key=YOUTUBE_API_KEY;
  Object.entries(params).forEach(([k,v])=>url.searchParams.set(k,v));
  const c=new AbortController(); activeControllers.push(c);
  const r=await fetch(url,{signal:c.signal});
  if(!r.ok){
    let detail=''; try{const j=await r.json(); detail=j?.error?.errors?.[0]?.reason||j?.error?.message||'';}catch(_){}
    throw new Error(`YouTube API ${r.status}${detail?': '+detail:''}`);
  }
  return r.json();
}

/* ì¬ìƒ ê°€ëŠ¥ ì—¬ë¶€ */
function isPlayable(v){
  if(!v) return false;
  if(v.status?.privacyStatus!=='public') return false;
  if(!v.status?.embeddable) return false;
  if(v.contentDetails?.contentRating?.ytRating==='ytAgeRestricted') return false;
  const rr=v.contentDetails?.regionRestriction;
  if(rr?.blocked && rr.blocked.includes(REGION)) return false;
  if(rr?.allowed && !rr.allowed.includes(REGION)) return false;
  return true;
}

/* ê²€ìƒ‰ (ë””ë°”ìš´ìŠ¤ 600ms) */
const doSearch = (()=> {
  let timer;
  return function(){
    clearTimeout(timer);
    timer = setTimeout(async ()=>{
      const q=$('#q').value.trim();
      $('#results').innerHTML='';
      if(!q) return;

      cancelActive();
      const mySeq=++searchSeq;

      try{
        const data=await yt('search',{part:'snippet',type:'video',maxResults:18,q,videoEmbeddable:'true',videoSyndicated:'true'});
        if(mySeq!==searchSeq) return;

        const ids=data.items.map(i=>i.id.videoId).join(',');
        if(!ids){ currentList=[]; return; }

        const vinfo=await yt('videos',{part:'snippet,contentDetails,status',id:ids});
        if(mySeq!==searchSeq) return;

        const byId=Object.fromEntries(vinfo.items.map(v=>[v.id,v]));
        const playable=data.items.filter(it=>isPlayable(byId[it.id.videoId]));

        currentList = playable.map(it=>({
          id: it.id.videoId,
          title: it.snippet.title,
          artist: it.snippet.channelTitle,
          thumb: (it.snippet.thumbnails.high||it.snippet.thumbnails.default).url
        }));

        const box=$('#results'); box.innerHTML='';
        currentList.forEach((t,idx)=>{
          const pp=prettify(t.title);
          const line=pp.artist?`${pp.title} - ${pp.artist}`:pp.title;
          const div=document.createElement('div'); div.className='item';
          div.innerHTML=`<img src="${t.thumb}"><div><div class="t">${line}</div><div class="s">${t.artist}</div></div>`;
          div.onclick=()=>selectTrack(idx);
          box.appendChild(div);
        });
      }catch(err){
        const msg=String(err.message||err);
        if(/quota|rate|429|403/i.test(msg)) toast('ì ì‹œ í›„ ë‹¤ì‹œ ê²€ìƒ‰í•´ ì£¼ì„¸ìš” (YouTube ì œí•œ)');
        else toast('ê²€ìƒ‰ ì˜¤ë¥˜: '+msg);
        console.error(err);
      }
    },600);
  };
})();
$('#q').addEventListener('input', doSearch);

/* YT Iframe Player */
function onYouTubeIframeAPIReady(){
  player=new YT.Player('player',{
    height:'0',width:'0',videoId:'',
    playerVars:{playsinline:1,rel:0,modestbranding:1},
    events:{
      onReady(){ try{player.setVolume(DEFAULT_VOLUME);}catch(_){ } $('#vol').value=DEFAULT_VOLUME; },
      onStateChange(e){ if(e.data===YT.PlayerState.PLAYING){isPlaying=true;$('#playBtn').textContent='â¸';} else {isPlaying=false;$('#playBtn').textContent='â–¶';}},
      onError(){ if(currentIndex<currentList.length-1) selectTrack(currentIndex+1); }
    }
  });
}
window.onYouTubeIframeAPIReady=onYouTubeIframeAPIReady;
const s=document.createElement('script'); s.src='https://www.youtube.com/iframe_api'; document.body.appendChild(s);

/* ì¹´ë“œ/íŠ¸ë™ */
function applyCover(){ $('#coverLock').style.display = customCoverLocked ? 'inline-block' : 'none'; $('#art').src=(customCoverLocked&&customCover)?customCover:defaultThumb; }
function selectTrack(idx){
  const t=currentList[idx]; if(!t) return; currentIndex=idx;
  $('#card').style.display='flex';
  defaultThumb=t.thumb;
  const pp=prettify(t.title);
  $('#title').textContent=pp.artist?`${pp.title} - ${pp.artist}`:pp.title;
  $('#artistTag').textContent=$('#channelInput').value||t.artist;
  createBars(36);
  if(player?.loadVideoById) player.loadVideoById(t.id);
  applyCover();
}

/* ì»¨íŠ¸ë¡¤ */
$('#playBtn').onclick=()=>{ if(isPlaying) player.pauseVideo(); else player.playVideo(); };
$('#prevBtn').onclick=()=>{ if(currentIndex>0) selectTrack(currentIndex-1); };
$('#nextBtn').onclick=()=>{ if(currentIndex<currentList.length-1) selectTrack(currentIndex+1); };
$('#muteBtn').onclick=()=>{ if(!player) return; if(player.isMuted()){player.unMute(); $('#muteBtn').textContent='ğŸ”Š';} else {player.mute(); $('#muteBtn').textContent='ğŸ”‡';} };

/* ë³¼ë¥¨ */
const volEl=$('#vol'); volEl.value=DEFAULT_VOLUME;
volEl.oninput=e=>{ const v=Number(e.target.value); try{player.setVolume(v);}catch(_){} localStorage.setItem('yt_card_vol',String(v)); };

/* ì±„ë„ëª… ì €ì¥ */
const channelInput=$('#channelInput');
channelInput.value=localStorage.getItem('yt_card_channel')||'';
channelInput.oninput=()=>{ localStorage.setItem('yt_card_channel',channelInput.value); if($('#card').style.display!=='none') $('#artistTag').textContent=channelInput.value; };

/* ì»¤ë²„ ì ìš©/ì›ë³µ */
function setCustomCover(src){
  if(!src) return;
  customCover=src; customCoverLocked=true;
  localStorage.setItem('yt_card_custom_cover',customCover);
  localStorage.setItem('yt_card_cover_locked','1');
  applyCover();
}
const coverUrlEl=$('#coverUrl');
coverUrlEl.addEventListener('keydown',e=>{ if(e.key==='Enter') setCustomCover(coverUrlEl.value.trim()); });
coverUrlEl.addEventListener('change', ()=> setCustomCover(coverUrlEl.value.trim()));
coverUrlEl.addEventListener('blur',   ()=> setCustomCover(coverUrlEl.value.trim()));
$('#coverFile').addEventListener('change', e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const reader=new FileReader();
  reader.onload=ev=>setCustomCover(ev.target.result);
  reader.readAsDataURL(f);
});
$('#coverApply').addEventListener('click', ()=> setCustomCover(coverUrlEl.value.trim()) );
$('#coverReset').addEventListener('click', ()=>{
  customCover=null; customCoverLocked=false;
  localStorage.removeItem('yt_card_custom_cover');
  localStorage.removeItem('yt_card_cover_locked');
  applyCover();
});

/* URL íŒŒë¼ë¯¸í„°(ì„ íƒ) & ë³µì› */
(function fromQuery(){
  const ch=params.get('channel'); const cv=params.get('cover');
  if(ch){ channelInput.value=ch; localStorage.setItem('yt_card_channel',ch); }
  if(cv){ customCover=cv; customCoverLocked=true; localStorage.setItem('yt_card_custom_cover',cv); localStorage.setItem('yt_card_cover_locked','1'); }
})();
(function restore(){
  const c=localStorage.getItem('yt_card_custom_cover');
  const locked=localStorage.getItem('yt_card_cover_locked')==='1';
  if(c){ customCover=c; customCoverLocked=locked; }
})();
</script>
</body>
</html>
